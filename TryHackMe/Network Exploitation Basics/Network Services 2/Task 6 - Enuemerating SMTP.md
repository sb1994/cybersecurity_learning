
### **Enumerating Server Details**

Poorly configured or vulnerable mail servers can often provide an initial foothold into a network, but prior to launching an attack, we want to fingerprint the server to make our targeting as precise as possible. We're going to use the "_smtp_version_" module in MetaSploit to do this. As its name implies, it will scan a range of IP addresses and determine the version of any mail servers it encounters.

### **Enumerating Users from SMTP**

The SMTP service has two internal commands that allow the enumeration of users: **VRFY** (confirming the names of valid users) and **EXPN** (which reveals the actual address of user’s aliases and lists of e-mail (mailing lists). Using these SMTP commands, we can reveal a list of valid users

We can do this manually, over a telnet connection- however Metasploit comes to the rescue again, providing a handy module appropriately called "_smtp_enum_" that will do the legwork for us! Using the module is a simple matter of feeding it a host or range of hosts to scan and a wordlist containing usernames to enumerate.

**Requirements**

As we're going to be using Metasploit for this, it's important that you have Metasploit installed. It is by default on both Kali Linux and Parrot OS; however, it's always worth doing a quick update to make sure that you're on the latest version before launching any attacks. You can do this with a simple "sudo apt update", and accompanying upgrade- if any are required.

**Alternatives**

It's worth noting that this enumeration technique will work for the majority of SMTP configurations; however there are other, non-metasploit tools such as smtp-user-enum that work even better for enumerating OS-level user accounts on Solaris via the SMTP service. Enumeration is performed by inspecting the responses to VRFY, EXPN, and RCPT TO commands.

This technique could be adapted in future to work against other vulnerable SMTP daemons, but this hasn’t been done as of the time of writing. It's an alternative that's worth keeping in mind if you're trying to distance yourself from using Metasploit e.g. in preparation for OSCP.  

Now we've covered the theory. Let's get going!

--------
1. Ran an NMap scan to see the open ports
```shell
nmap -A -p-  -T3 -sX -oN initial_smtp 10.10.225.121 -vv
Starting Nmap 7.92 ( https://nmap.org ) at 2022-11-27 20:02 EST
NSE: Loaded 155 scripts for scanning.
NSE: Script Pre-scanning.
NSE: Starting runlevel 1 (of 3) scan.
Initiating NSE at 20:02
Completed NSE at 20:02, 0.00s elapsed
NSE: Starting runlevel 2 (of 3) scan.
Initiating NSE at 20:02
Completed NSE at 20:02, 0.00s elapsed
NSE: Starting runlevel 3 (of 3) scan.
Initiating NSE at 20:02
Completed NSE at 20:02, 0.00s elapsed
Initiating Ping Scan at 20:02
Scanning 10.10.225.121 [4 ports]
Completed Ping Scan at 20:02, 0.07s elapsed (1 total hosts)
Initiating Parallel DNS resolution of 1 host. at 20:02
Completed Parallel DNS resolution of 1 host. at 20:02, 0.00s elapsed
Initiating XMAS Scan at 20:02
Scanning 10.10.225.121 [65535 ports]
Completed XMAS Scan at 20:02, 9.80s elapsed (65535 total ports)
Initiating Service scan at 20:02
Scanning 2 services on 10.10.225.121
Discovered open port 22/tcp on 10.10.225.121
Discovered open|filtered port 22/tcp on 10.10.225.121 is actually open
Discovered open port 25/tcp on 10.10.225.121
Discovered open|filtered port 25/tcp on 10.10.225.121 is actually open
Completed Service scan at 20:02, 0.13s elapsed (2 services on 1 host)
Initiating OS detection (try #1) against 10.10.225.121
Retrying OS detection (try #2) against 10.10.225.121
Retrying OS detection (try #3) against 10.10.225.121
Retrying OS detection (try #4) against 10.10.225.121
Retrying OS detection (try #5) against 10.10.225.121
Initiating Traceroute at 20:03
Completed Traceroute at 20:03, 0.01s elapsed
Initiating Parallel DNS resolution of 2 hosts. at 20:03
Completed Parallel DNS resolution of 2 hosts. at 20:03, 0.01s elapsed
NSE: Script scanning 10.10.225.121.
NSE: Starting runlevel 1 (of 3) scan.
Initiating NSE at 20:03
Completed NSE at 20:03, 0.52s elapsed
NSE: Starting runlevel 2 (of 3) scan.
Initiating NSE at 20:03
Completed NSE at 20:03, 1.26s elapsed
NSE: Starting runlevel 3 (of 3) scan.
Initiating NSE at 20:03
Completed NSE at 20:03, 0.00s elapsed
Nmap scan report for 10.10.225.121
Host is up, received echo-reply ttl 63 (0.0086s latency).
Scanned at 2022-11-27 20:02:37 EST for 25s
Not shown: 65533 closed tcp ports (reset)
PORT   STATE SERVICE REASON       VERSION
22/tcp open  ssh     tcp-response OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   2048 62:a7:03:13:39:08:5a:07:80:1a:e5:27:ee:9b:22:5d (RSA)
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDLzGW2N+TMgb36oZ5nXTWZx9xxdat6dZjm0MWKiczo7KS/9C/YA5LKMhbsEwU7lKePA8wrK+8GGOMO0LI7EHwxhmBxbJfXZaiuKjATTFT0A5S8qHC/dArC2JtLarYuEC9kInteBvoboE/Oo+27W+b/1e9SjeVp8KtMFyJa73SGR875DvD3mZFeNGv1IOLUrPm7GJVLIJCFlZqFdSBrn0pPkaNN2h0z8XvIvZwTvSeIANpTi1BWt5NpMuSo5qbYxCgBmoysmQyp5SHQceqKUFYHEiYXZIBMs2nQww5plyUCI4b09vaF0rAEqaS++scnYGc3ldVVq0Ffc0v5VbwvOstN
|   256 89:d0:40:92:15:09:39:70:17:6e:c5:de:5b:59:ee:cb (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBB4NrsBAERAQTG53D50OgCR5yvxTY6iUr0dpKnaAQCvHgux0GzPoxcBT+mH4+3E3GrFJqulw/hI2TjjEUsRo/3E=
|   256 56:7c:d0:c4:95:2b:77:dd:53:d6:e6:73:99:24:f6:86 (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIFig3TbPjHOAaFOKJkPU+5++IeUlAsIWaxq3QM5tIacZ
25/tcp open  smtp    tcp-response Postfix smtpd
|_smtp-commands: polosmtp.home, PIPELINING, SIZE 10240000, VRFY, ETRN, STARTTLS, ENHANCEDSTATUSCODES, 8BITMIME, DSN, SMTPUTF8
| ssl-cert: Subject: commonName=polosmtp
| Subject Alternative Name: DNS:polosmtp
| Issuer: commonName=polosmtp
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2020-04-22T18:38:06
| Not valid after:  2030-04-20T18:38:06
| MD5:   5c21 92bb 0da5 82d6 7b45 a851 7651 7137
| SHA-1: eb6c 0d88 57e6 8ba7 8308 aac8 9c34 0836 d2a1 c133
| -----BEGIN CERTIFICATE-----
| MIIC1jCCAb6gAwIBAgIUZ0vVVd2ClfM+TsEBsGtkaQcOg7kwDQYJKoZIhvcNAQEL
| BQAwEzERMA8GA1UEAwwIcG9sb3NtdHAwHhcNMjAwNDIyMTgzODA2WhcNMzAwNDIw
| MTgzODA2WjATMREwDwYDVQQDDAhwb2xvc210cDCCASIwDQYJKoZIhvcNAQEBBQAD
| ggEPADCCAQoCggEBALh2Ab5smNG1TfJHozg7ZJMEXw6S6PoGd30P5i+ZiwUq4Qkl
| 8bYFeKl3UQ29sosA+CeCoP5aNXrF5k0J+nzWkI/DuJO0u4Yk6TxdgtJVEfb8A520
| dgg+ED5sO7JAMMaGRNVzzXR7r/DaqdgivHuCcSvH7Pl1C3apqa0M5rmEWkfrgmKE
| 5A3jjLFkjzvJId07kdk2SMFfCYG6nHVVLNzkN1v/plJcDE99rKn18YDI2OI6Mlj4
| ukENJvu0ekmQo6s4Pr2xILNLpCyebtiVl08Rv88HHo+RMNqQyiO3g2myJeGbwfPD
| NuwJ8fZbjve8yvAbUMkIInXROXCtke1ffRLFOicCAwEAAaMiMCAwCQYDVR0TBAIw
| ADATBgNVHREEDDAKgghwb2xvc210cDANBgkqhkiG9w0BAQsFAAOCAQEARg/+u5PH
| FUSf7mWS+4XPA7krdhIo2gPT8XMME0bQlLP0DR2udWDc+QxTXb2CalLRV7+R+VVc
| DfJ2tGSNz4myiy3XdT2G0EofxCojoddU+qoJw5KbLdvKAcZL21dtECy4Jl/7j6jU
| O9/Lc8Whwq5otQNV77xQ+MrTOfl+BGrRD6WOJNga12RqeD5GZtzD1Aij3zvhKlXQ
| fbXIj6DRDIaTlBGEECd6nPPaAoCSAPD2XEyAh0k+Qi8wFTNaOIMtDJnvWDKm12Jb
| 8C8tpEMO2Th3NA1Z7XPnnYOuCtbJ9ISpOe/a72+ERdIdeFLqARURCq3fbKIIuE37
| fujfT9EtIKryLg==
|_-----END CERTIFICATE-----
|_ssl-date: TLS randomness does not represent time
No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ).
TCP/IP fingerprint:
OS:SCAN(V=7.92%E=4%D=11/27%OT=22%CT=1%CU=44163%PV=Y%DS=2%DC=T%G=Y%TM=638408
OS:C6%P=x86_64-pc-linux-gnu)SEQ(SP=101%GCD=1%ISR=101%TI=Z%CI=Z%II=I%TS=A)OP
OS:S(O1=M505ST11NW7%O2=M505ST11NW7%O3=M505NNT11NW7%O4=M505ST11NW7%O5=M505ST
OS:11NW7%O6=M505ST11)WIN(W1=F4B3%W2=F4B3%W3=F4B3%W4=F4B3%W5=F4B3%W6=F4B3)EC
OS:N(R=Y%DF=Y%T=40%W=F507%O=M505NNSNW7%CC=Y%Q=)T1(R=Y%DF=Y%T=40%S=O%A=S+%F=
OS:AS%RD=0%Q=)T2(R=N)T3(R=N)T4(R=Y%DF=Y%T=40%W=0%S=A%A=Z%F=R%O=%RD=0%Q=)T5(
OS:R=Y%DF=Y%T=40%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)T6(R=Y%DF=Y%T=40%W=0%S=A%A=Z%
OS:F=R%O=%RD=0%Q=)T7(R=Y%DF=Y%T=40%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)U1(R=Y%DF=N
OS:%T=40%IPL=164%UN=0%RIPL=G%RID=G%RIPCK=G%RUCK=G%RUD=G)IE(R=Y%DFI=N%T=40%C
OS:D=S)

Uptime guess: 35.344 days (since Sun Oct 23 12:47:28 2022)
Network Distance: 2 hops
TCP Sequence Prediction: Difficulty=258 (Good luck!)
IP ID Sequence Generation: All zeros
Service Info: Host:  polosmtp.home; OS: Linux; CPE: cpe:/o:linux:linux_kernel

TRACEROUTE (using port 1025/tcp)
HOP RTT     ADDRESS
1   7.43 ms 10.9.0.1
2   7.74 ms 10.10.225.121

NSE: Script Post-scanning.
NSE: Starting runlevel 1 (of 3) scan.
Initiating NSE at 20:03
Completed NSE at 20:03, 0.00s elapsed
NSE: Starting runlevel 2 (of 3) scan.
Initiating NSE at 20:03
Completed NSE at 20:03, 0.00s elapsed
NSE: Starting runlevel 3 (of 3) scan.
Initiating NSE at 20:03
Completed NSE at 20:03, 0.00s elapsed
Read data files from: /usr/bin/../share/nmap
OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 26.31 seconds
           Raw packets sent: 65669 (2.631MB) | Rcvd: 65614 (2.628MB)

```

found that 2 ports were open 22(ssh) and 25(smtp)
```
2/tcp open  ssh     tcp-response OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   2048 62:a7:03:13:39:08:5a:07:80:1a:e5:27:ee:9b:22:5d (RSA)
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDLzGW2N+TMgb36oZ5nXTWZx9xxdat6dZjm0MWKiczo7KS/9C/YA5LKMhbsEwU7lKePA8wrK+8GGOMO0LI7EHwxhmBxbJfXZaiuKjATTFT0A5S8qHC/dArC2JtLarYuEC9kInteBvoboE/Oo+27W+b/1e9SjeVp8KtMFyJa73SGR875DvD3mZFeNGv1IOLUrPm7GJVLIJCFlZqFdSBrn0pPkaNN2h0z8XvIvZwTvSeIANpTi1BWt5NpMuSo5qbYxCgBmoysmQyp5SHQceqKUFYHEiYXZIBMs2nQww5plyUCI4b09vaF0rAEqaS++scnYGc3ldVVq0Ffc0v5VbwvOstN
|   256 89:d0:40:92:15:09:39:70:17:6e:c5:de:5b:59:ee:cb (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBB4NrsBAERAQTG53D50OgCR5yvxTY6iUr0dpKnaAQCvHgux0GzPoxcBT+mH4+3E3GrFJqulw/hI2TjjEUsRo/3E=
|   256 56:7c:d0:c4:95:2b:77:dd:53:d6:e6:73:99:24:f6:86 (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIFig3TbPjHOAaFOKJkPU+5++IeUlAsIWaxq3QM5tIacZ
25/tcp open  smtp    tcp-response Postfix smtpd
|_smtp-commands: polosmtp.home, PIPELINING, SIZE 10240000, VRFY, ETRN, STARTTLS, ENHANCEDSTATUSCODES, 8BITMIME, DSN, SMTPUTF8
| ssl-cert: Subject: commonName=polosmtp
| Subject Alternative Name: DNS:polosmtp
| Issuer: commonName=polosmtp
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2020-04-22T18:38:06
| Not valid after:  2030-04-20T18:38:06
| MD5:   5c21 92bb 0da5 82d6 7b45 a851 7651 7137
| SHA-1: eb6c 0d88 57e6 8ba7 8308 aac8 9c34 0836 d2a1 c133
| -----BEGIN CERTIFICATE-----
| MIIC1jCCAb6gAwIBAgIUZ0vVVd2ClfM+TsEBsGtkaQcOg7kwDQYJKoZIhvcNAQEL
| BQAwEzERMA8GA1UEAwwIcG9sb3NtdHAwHhcNMjAwNDIyMTgzODA2WhcNMzAwNDIw
| MTgzODA2WjATMREwDwYDVQQDDAhwb2xvc210cDCCASIwDQYJKoZIhvcNAQEBBQAD
| ggEPADCCAQoCggEBALh2Ab5smNG1TfJHozg7ZJMEXw6S6PoGd30P5i+ZiwUq4Qkl
| 8bYFeKl3UQ29sosA+CeCoP5aNXrF5k0J+nzWkI/DuJO0u4Yk6TxdgtJVEfb8A520
| dgg+ED5sO7JAMMaGRNVzzXR7r/DaqdgivHuCcSvH7Pl1C3apqa0M5rmEWkfrgmKE
| 5A3jjLFkjzvJId07kdk2SMFfCYG6nHVVLNzkN1v/plJcDE99rKn18YDI2OI6Mlj4
| ukENJvu0ekmQo6s4Pr2xILNLpCyebtiVl08Rv88HHo+RMNqQyiO3g2myJeGbwfPD
| NuwJ8fZbjve8yvAbUMkIInXROXCtke1ffRLFOicCAwEAAaMiMCAwCQYDVR0TBAIw
| ADATBgNVHREEDDAKgghwb2xvc210cDANBgkqhkiG9w0BAQsFAAOCAQEARg/+u5PH
| FUSf7mWS+4XPA7krdhIo2gPT8XMME0bQlLP0DR2udWDc+QxTXb2CalLRV7+R+VVc
| DfJ2tGSNz4myiy3XdT2G0EofxCojoddU+qoJw5KbLdvKAcZL21dtECy4Jl/7j6jU
| O9/Lc8Whwq5otQNV77xQ+MrTOfl+BGrRD6WOJNga12RqeD5GZtzD1Aij3zvhKlXQ
| fbXIj6DRDIaTlBGEECd6nPPaAoCSAPD2XEyAh0k+Qi8wFTNaOIMtDJnvWDKm12Jb
| 8C8tpEMO2Th3NA1Z7XPnnYOuCtbJ9ISpOe/a72+ERdIdeFLqARURCq3fbKIIuE37
| fujfT9EtIKryLg==
|_-----END CERTIFICATE-----

```
2. Started up the Metasploit console, it can use all the linux commands
```shell
msfconsole


msf6 > ls
[*] exec: ls

authorized_keys  id_rsa  id_rsa.pub  initial_smtp  scan1
msf6 > ls
[*] exec: ls

authorized_keys  id_rsa  id_rsa.pub  initial_smtp  scan1
msf6 > 

```
3. Ran search to find the exploit, full name of the module is **auxiliary/scanner/smtp/smtp_version**
```shell
msf6 > search smtp_version
                                                        
Matching Modules                                        
================                                        
                                                        
   #  Name                                 Disclosure Date  Rank    Check  Description
   -  ----                                 ---------------  ----    -----  -----------
   0  auxiliary/scanner/smtp/smtp_version                   normal  No     SMTP Banner Grabber
```

4. To get the information on the exploit need to run info and the index of the expoit in the command line 
```shell
msf6 > info 0

Basic options:
  Name     Current Setting  Required  Description
  ----     ---------------  --------  -----------
  RHOSTS                    yes       The target host(s), see https://github.com/rapid7/metasploit-framework/wiki/
                                      Using-Metasploit
  RPORT    25               yes       The target port (TCP)
  THREADS  1                yes       The number of concurrent threads (max one per host)

Description:
  SMTP Banner Grabber

```
5. Set the RHOSTS to the the target machine
```shell
msf6 > use auxiliary/scanner/smtp/smtp_version
msf6 auxiliary(scanner/smtp/smtp_version) > RHOSTS polosmtp.home
[-] Unknown command: RHOSTS
msf6 auxiliary(scanner/smtp/smtp_version) > set RHOSTS polosmtp.home
RHOSTS => polosmtp.home
```

It didn't work when I set the RHOSTS to the domain so i changed the RHOSTS to the IP address and ran the exploit it returned the following 
```shell 
msf6 auxiliary(scanner/smtp/smtp_version) > set RHOSTS 10.10.225.121
RHOSTS => 10.10.225.121
msf6 auxiliary(scanner/smtp/smtp_version) > exploit

[+] 10.10.225.121:25      - 10.10.225.121:25 SMTP 220 polosmtp.home ESMTP Postfix (Ubuntu)\x0d\x0a
[*] 10.10.225.121:25      - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
```
found that they are running **Postfix** as their smtp server(Mail Agent) on Ubuntu and their domain is **polosmtp.home**

6. Searched for auxiliary/scanner/smtp/smtp_enum and set it to be the script that willl be used. looked at the options for it 
```shell
msf6 auxiliary(scanner/smtp/smtp_version) > use auxiliary/scanner/smtp/smtp_enum

msf6 auxiliary(scanner/smtp/smtp_enum) > show options

Module options (auxiliary/scanner/smtp/smtp_enum):

   Name       Current Setting                   Required  Description
   ----       ---------------                   --------  -----------
   RHOSTS                                       yes       The target host(s), see https://github.com/rapid7/metasp
                                                          loit-framework/wiki/Using-Metasploit
   RPORT      25                                yes       The target port (TCP)
   THREADS    1                                 yes       The number of concurrent threads (max one per host)
   UNIXONLY   true                              yes       Skip Microsoft bannered servers when testing unix users
   USER_FILE  /usr/share/metasploit-framework/  yes       The file that contains a list of probable users accounts
              data/wordlists/unix_users.txt               .


```
7. Set the user lisit to use an other list othen than default
```shell
msf6 auxiliary(scanner/smtp/smtp_enum) > set USER_FILE /usr/share/seclists/Usernames/top-usernames-shortlist.txt
USER_FILE => /usr/share/seclists/Usernames/top-usernames-shortlist.txt

```
8. set the RHOSTS parameter as this needs to be also set
```shell
set RHOSTS 10.10.225.121
```

9. Ran the exploit and found the user name to be administrator
```shell
msf6 auxiliary(scanner/smtp/smtp_enum) > exploit

[*] 10.10.225.121:25      - 10.10.225.121:25 Banner: 220 polosmtp.home ESMTP Postfix (Ubuntu)
[+] 10.10.225.121:25      - 10.10.225.121:25 Users found: administrator
[*] 10.10.225.121:25      - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed

```